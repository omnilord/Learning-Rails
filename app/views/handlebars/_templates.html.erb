<script type="text/x-handlebars-template" id="handlebars-spinner">
<div class="container">
  <div class="row">
    <div id="spinner" class="col-md-4 col-md-offset-4 spinner">
      <i class="fa fa-spinner fa-spin"></i>
    </div>
  </div>
</div>
</script>


<script type="text/x-handlebars-partial" id="handlebars-stock">
<div class="panel panel-default stock" data-stock-id="{{stock.id}}" data-user-stocks-id="{{track.id}}">
  <div class="panel-heading">
    <h3 class="panel-title">
      <span class="stock-ticker">{{stock.ticker}}</span>
      <span class="stock-price pull-right">{{stock.last_price}}</span>
    </h3>
  </div>
  <div class="panel-body">
    <span class="stock-name">{{stock.name}}</span>
  </div>
  <div class="panel-footer">
    <% if user_signed_in? %>
      <div class="row">
        <div class="col-md-4">
          <div class="input-group input-group-sm form-group form-group-sm" style="margin-bottom: 0; text-align: left;">
            <%= number_field_tag nil, nil,
                                 placeholder: '#',
                                 class: 'form-control stock-count-edit',
                                 style: 'width: 4em',
                                 min: '0' %>
            <span class="input-group-btn pull-left">
              <%= button_tag name: nil, type: :button, class: 'btn btn-primary add-stock-to-portfolio' do %>
                <i class="glyphicon glyphicon-plus"></i>
              <% end %>
              {{#if track}}
                {{#if track.owned}}
                  <%= button_tag name: nil, type: :button, class: 'btn btn-warning subtract-stock-from-portfolio' do %>
                    <i class="glyphicon glyphicon-minus"></i>
                  <% end %>
                  <%= button_tag name: nil, type: :button, class: 'btn btn-danger remove-stock-from-portfolio' do %>
                    <i class="glyphicon glyphicon-remove"></i>
                  <% end %>
                {{/if}}
              {{/if}}
            </span>
          </div>
        </div>
        <div class="col-md-8">
          <span class="pull-right text-right">
          {{#if track.owned}}
            <div><small>Shares owned:</small> <strong>{{track.owned}}</strong></div>
            <div><small>Value:</small> <strong>{{math track.owned "*" stock.last_price precision=2 thousands=","}}</strong></div>
          {{else if track}}
          <%= button_tag name: nil, type: :button, class: 'btn btn-primary remove-stock-from-watchlist' do %>
            Remove
          <% end %>
          {{else}}
          <%= button_tag name: nil, type: :button, class: 'btn btn-primary add-stock-to-watchlist' do %>
            Add to Watchlist
          <% end %>
          {{/if}}
          </span>
        </div>
      </div>
    <% end %>
  </div>
</div>
</script>


<script type="text/x-handlebars-template" id="handlebars-stock_search_result">
<div class="container">
  <div class="row" data-rm-action="replace">
    <div class="col-md-8 col-md-offset-2">
      {{> stock}}
    </div>
  </div>
</div>
</script>


<script type="text/x-handlebars-template" id="handlebars-portfolio">
  <div class="container">
    <div class="row" data-rm-action="remove">
      {{#each data}}
        <div class="col-md-4">
          {{> stock}}
        </div>
      {{/each}}
    </div>
  </div>
</script>


<script type="text/x-handlebars-template" id="handlebars-error">
<div class="container">
  <div class="row">
    <div class="col-md-8 col-md-offset-2 error">
      <div class="panel panel-danger">
        <div class="panel-heading">
          <h3 class="panel-title">Error</h3>
        </div>
        <div class="panel-body">
          {{msg}}
        </div>
        <div class="panel-footer"></div>
      </div>
    </div>
  </div>
</div>
</script>


<script>

/*
  All of the code for running the above templates is stored here:
*/

$(function () {
  var maindiv = $('#main_content'),
      user = <%= current_user.to_json(only: [:id, :email, :created_at]).html_safe %>,
      templates = {}, partials = {},
      nav_search = $('#search-stock-form').on({
        'ajax:success': function (ev, data, status) {
          maindiv.html(templates.stock_search_result(data.data));
        },
        'ajax:before': function () {
          maindiv.html(templates.spinner());
        },
        'ajax:after': function () {
          maindiv.html(templates.spinner());
        },
        'ajax:error': function (ev, xhr, status, err) {
          maindiv.html(templates.error({msg: 'No stock found.'}));
        }
      }),
      search_val = nav_search.closest('div').find('input[type="text"]').val();
  <% if user_signed_in? %>

  const toggle_spinners = ($btn) => {
    $btn.parent().find('button').each(function () {
      $(this).html('<i class="fa fa-spinner fa-spin"></i>').prop('disabled', true);
    });
  }

  // Add or update a Portfolio stock
  $(document)
    .on('click', 'button.add-stock-to-portfolio, button.subtract-stock-from-portfolio, button.add-stock-to-watchlist', function () {
      var $btn = $(this),
          $this = $btn.closest('[data-stock-id]'),
          stock_id = parseInt($this.attr('data-stock-id')) || null,
          user_stock_id = parseInt($this.attr('data-user-stocks-id')) || null,
          count = parseInt($btn.parent().siblings('input.stock-count-edit').val());

      if (count < 1) {
        return;
      }

      if ($btn.is('.subtract-stock-from-portfolio')) {
        count *= -1;
      } else if ($btn.is('.add-stock-to-watchlist')) {
        count = 0;
      }

      $.ajax({
        url: '<%= user_stocks_path %>' + (user_stock_id ? '/' + user_stock_id : ''),
        data: {
          user: user.id,
          stock_id: stock_id,
          user_stock_id: user_stock_id,
          count: isNaN(count) ? 0 : count
        },
        method: user_stock_id ? 'PATCH' : 'POST',
        dataType: 'json',
        beforeSend: toggle_spinners($btn)
      })
        .done(function (data) {
          $this.replaceWith(templates.stock(data.data));
        })
        .fail(function (data) {
          $this.replaceWith(templates.error({msg: 'Failed to add stock.'}));
        });
    })
    .on('click', 'button.remove-stock-from-portfolio, button.remove-stock-from-watchlist', function () {
      var $btn = $(this),
          $this = $btn.closest('[data-stock-id]'),
          user_stock_id = parseInt($this.attr('data-user-stocks-id')) || null,
          action = $this.closest('[data-rm-action]').attr('data-rm-action');

      $.ajax({
        url: '<%= user_stocks_path %>/' + user_stock_id,
        method: 'DELETE',
        dataType: 'json',
        beforeSend: toggle_spinners($btn)
      })
        .done(function (data) {
          if (action == 'remove') {
            $this.remove();
          } else {
            $this.replaceWith(templates.stock(data.data));
          }
        })
        .fail(function (data) {
          $this.replaceWith(templates.error({msg: 'Failed to remove stock.'}));
        });
    });


  // Handle numeric inputs into the count input
  $(document).on('keyup keydown', 'input.stock-count-edit', function (ev) {
    if ((ev.keyCode < 48 || ev.keyCode > 57) && [8, 9, 13, 46].indexOf(ev.keyCode) == -1) {
      ev.preventDefault();
    }
  });

  <% end %>


  // Pre-load helpers
  Handlebars.registerHelper('math', function (lvalue, operator, rvalue, options) {
    lvalue = parseFloat(lvalue);
    rvalue = parseFloat(rvalue);

    var v = {
        '+': lvalue + rvalue,
        '-': lvalue - rvalue,
        '*': lvalue * rvalue,
        '/': lvalue / rvalue,
        '%': lvalue % rvalue
    }[operator].toFixed(options.hash.precision || -1);
    if (options.hash.thousands) {
      v = v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, options.hash.thousands);
    }
    return v;
  });


  // Load all templates
  $('script[type|="text/x-handlebars"]').each((() => {
    var hclr = /^(text\/x\-)?handlebars\-/;

    return function () {
      var id = this.id.replace(hclr, ''),
          type = this.getAttribute('type').replace(hclr, '');

      if (type == 'partial') {
        partials[id] = Handlebars.registerPartial(id, this.innerHTML);
      }
      templates[id] = Handlebars.compile(this.innerHTML);
      console.log(templates.hasOwnProperty(id), id + ' ' + type + ' loaded.', this);
    };
  })());


  // Immediate executions
  if (search_val != '') {
    nav_search.submit();
  }

  window.railsstockapp = {
    templates: templates
  };
});
</script>
