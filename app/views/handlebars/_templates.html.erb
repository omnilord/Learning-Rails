<script type="text/x-handlebars-partial" id="handlebars-spinner">
  <i class="fa fa-spinner fa-spin"></i>
</script>


<script type="text/x-handlebars-template" id="handlebars-spinner_row">
<div class="container">
  <div class="row">
    <div class="col-md-4 col-md-offset-4 spinner">
      {{> spinner}}
    </div>
  </div>
</div>
</script>


<script type="text/x-handlebars-partial" id="handlebars-stock">
<div class="panel panel-default stock" data-stock-id="{{stock.id}}" data-user-stocks-id="{{track.id}}">
  <div class="panel-heading">
    <h3 class="panel-title">
      <span class="stock-ticker">{{stock.ticker}}</span>
      <span class="stock-price pull-right">{{math stock.last_price "+" 0 precision=2 thousands="," prefix="$"}}</span>
    </h3>
  </div>
  <div class="panel-body">
    <span class="stock-name">{{stock.name}}</span>
  </div>
  <div class="panel-footer">
    <% if user_signed_in? %>
      <div class="row">
        <div class="col-md-4">
          <div class="input-group input-group-sm form-group form-group-sm" style="margin-bottom: 0; text-align: left;">
            <%= number_field_tag nil, nil,
                                 placeholder: '#',
                                 class: 'form-control stock-count-edit',
                                 style: 'width: 4em',
                                 min: '0' %>
            <span class="input-group-btn pull-left">
              <%= button_tag name: nil, type: :button, class: 'btn btn-primary add-stock-to-portfolio' do %>
                <i class="glyphicon glyphicon-plus"></i>
              <% end %>
              {{#if track}}
                {{#if track.owned}}
                  <%= button_tag name: nil, type: :button, class: 'btn btn-warning subtract-stock-from-portfolio' do %>
                    <i class="glyphicon glyphicon-minus"></i>
                  <% end %>
                  <%= button_tag name: nil, type: :button, class: 'btn btn-danger remove-stock-from-portfolio' do %>
                    <i class="glyphicon glyphicon-trash"></i>
                  <% end %>
                {{/if}}
              {{/if}}
            </span>
          </div>
        </div>
        <div class="col-md-8">
          <span class="pull-right text-right">
          {{#if track.owned}}
            <div><small>Shares owned:</small> <strong>{{track.owned}}</strong></div>
            <div><small>Value:</small> <strong>{{math track.owned "*" stock.last_price precision=2 thousands="," prefix="$"}}</strong></div>
          {{else if track}}
          <%= button_tag name: nil, type: :button, class: 'btn btn-primary remove-stock-from-watchlist' do %>
            <i class="glyphicon glyphicon-eye-close"></i>
          <% end %>
          {{else}}
          <%= button_tag name: nil, type: :button, class: 'btn btn-primary add-stock-to-watchlist' do %>
            <i class="glyphicon glyphicon-eye-open"></i>
          <% end %>
          {{/if}}
          </span>
        </div>
      </div>
    <% end %>
  </div>
</div>
</script>


<script type="text/x-handlebars-partial" id="handlebars-friend">
<div class="panel panel-info friend" data-user-id="{{user_id}}">
  <div class="panel-heading">
    <h3 class="panel-title">
      <span class="username">{{fullname}}</span><br/>
      <small>{{email}}</small>
    </h3>
  </div>
  <div class="panel-body">
    <table><tbody>
      <tr><td>Stocks Watched:</td><td><span class="badge pull-right">{{portfolio.watches}}</span></td></tr>
      <tr><td>Stocks Owned:</td><td><span class="badge pull-right">{{portfolio.stocks}}</span></td></tr>
      <tr><td>Shares Owned:</td><td><span class="badge pull-right">{{portfolio.shares}}</span></td></tr>
      <tr><td>Portfolio Value:</td><td><span class="badge pull-right">{{math portfolio.value "+" 0 precision=2 thousands="," prefix="$"}}</span></td></tr>
    </tbody></table>
  </div>
  <div class="panel-footer">
    <div class="row">
      <span class="pull-right">
        <a class="btn btn-info btn-xs view-friend" href="<%= friends_path %>/{{user_id}}">
          <i class="glyphicon glyphicon-user"></i>
          View
        </a>
        <button class="btn btn-danger btn-xs remove-friendship">
          <i class="glyphicon glyphicon-trash"></i>
          Remove
        </button>
      </span>
    </div>
  </div>
</div>
</script>


<script type="text/x-handlebars-template" id="handlebars-stock_search_result">
<div class="container">
  <div class="row" data-rm-action="replace">
    <div class="col-md-8 col-md-offset-2">
      {{> stock}}
    </div>
  </div>
</div>
</script>


<script type="text/x-handlebars-partial" id="handlebars-portfolio_list">
<div class="row" {{#if removeable}}data-rm-action="remove"{{/if}}>
  {{#each data.stocks}}
    <div class="col-md-4">
      {{> stock}}
    </div>
   {{else}}
   <div class="col-md-4">
     <p>No stocks in {{#if pronoun}}{{pronoun}}{{else}}their{{/if}} portfolio.</p>
   </div>
  {{/each}}
</div>
</script>


<script type="text/x-handlebars-template" id="handlebars-portfolio">
  <div class="container">
    <h2 align="center">
      My Portfolio
      <small>
        {{data.stocks.length}} stock(s) ({{data.portfolio.stocks}} owned),
        {{data.portfolio.shares}} share(s),
        value: <em>{{math data.portfolio.value "+" 0 precision=2 thousands="," prefix="$"}}</em>
      </small>
      <hr/>
    </h2>
    {{> portfolio_list removeable=true pronoun="your"}}
  </div>
</script>


<script type="text/x-handlebars-template" id="handlebars-friends">
  <div class="container">
    <h2 align="center">
      My Friends
      <small>({{data.friends.length}} friends)</small>
    </h2>
    <div class="row">
        {{#if data.friends}}
          {{#each data.friends}}
            <div class="col-md-3">
              {{> friend}}
            </div>
          {{/each}}
        {{else}}
      <div class="col-md-10 col-md-offset-1">
        <table class="table table-striped centering">
          <thead>
            <tr>
              <th>Friend</th>
              <th>Stocks Owned</th>
              <th>Stocks Watched</th>
              <th>Shares</th>
              <th>Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {{#each data.friends}}
            <tr data-user-id="{{user_id}}">
              <td>{{fullname}}<br/><small>{{email}}</small></td>
              <td>{{portfolio.stocks}}</td>
              <td>{{portfolio.watches}}</td>
              <td>{{portfolio.shares}}</td>
              <td>{{math portfolio.value "+" 0 precision=2 thousands="," prefix="$"}}</td>
              <td>
                <button class="btn btn-info btn-xs view-friend">
                  <i class="glyphicon glyphicon-user"></i>
                  View
                </button>
                <button class="btn btn-danger btn-xs remove-friendship">
                  <i class="glyphicon glyphicon-trash"></i>
                  Remove
                </button>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
        {{/if}}
    </div>
  </div>
</script>


<script type="text/x-handlebars-template" id="handlebars-friend_portfolio">
<div class="container friend-portfolio">
  <div class="row center">
    <div class="col-md-6 col-md-offset-3" id="friendinfo">
      <h3>
        {{data.friend.fullname}}<br/>
        <small><%= mail_to '{{data.friend.email}}' %></small>
      </h3>
      <div class="row">
        <div class="col-md-3">
          Stocks Watched: <span class="badge">{{data.portfolio.watches}}</span>
        </div>
        <div class="col-md-3">
          Stocks Owned: <span class="badge">{{data.portfolio.stocks}}</span>
        </div>
        <div class="col-md-3">
          Shares Owned: <span class="badge">{{data.portfolio.shares}}</span>
        </div>
        <div class="col-md-3">
          Portfolio Value: <span class="badge">
            {{math data.portfolio.value "+" 0 precision=2 thousands="," prefix="$"}}
          </span>
        </div>
      </div>
    </div>
  </div>
  <hr/>
  {{> portfolio_list}}
</div>
</script>


<script type="text/x-handlebars-template" id="handlebars-error">
<div class="container">
  <div class="row">
    <div class="col-md-8 col-md-offset-2 error">
      <div class="panel panel-danger">
        <div class="panel-heading">
          <h3 class="panel-title">Error</h3>
        </div>
        <div class="panel-body">
          {{msg}}
        </div>
        <div class="panel-footer"></div>
      </div>
    </div>
  </div>
</div>
</script>


<script>

/*
  All of the code for running the above templates is stored here:
*/

$(function () {
  var maindiv = $('#main_content'),
      user = <%= current_user.to_json(only: [:id, :email, :created_at]).html_safe %>,
      templates = {}, partials = {},
      nav_search = $('#search-stock-form').on({
        'ajax:success': function (ev, data, status) {
          maindiv.html(templates.stock_search_result(data.data));
        },
        'ajax:before': function () {
          maindiv.html(templates.spinner());
        },
        'ajax:after': function () {
          maindiv.html(templates.spinner());
        },
        'ajax:error': function (ev, xhr, status, err) {
          maindiv.html(templates.error({msg: 'No stock found.'}));
        }
      }),
      search_val = nav_search.closest('div').find('input[type="text"]').val(),
      spinner;

  const toggle_spinners = ($btn) => {
    $btn.parent().find('button').each(function () {
      $(this).html(spinner).prop('disabled', true);
    });
  }

  <% if user_signed_in? %>

  $(document)
    // Manipulating stock portfolio
    .on('click', 'button.add-stock-to-portfolio, button.subtract-stock-from-portfolio, button.add-stock-to-watchlist', function () {
      var $btn = $(this),
          $this = $btn.closest('[data-stock-id]'),
          stock_id = parseInt($this.attr('data-stock-id')) || null,
          user_stock_id = parseInt($this.attr('data-user-stocks-id')) || null,
          count = parseInt($btn.parent().siblings('input.stock-count-edit').val());

      if (count < 1) {
        return;
      }

      if ($btn.is('.subtract-stock-from-portfolio')) {
        count *= -1;
      } else if ($btn.is('.add-stock-to-watchlist')) {
        count = 0;
      }

      $.ajax({
        url: '<%= user_stocks_path %>' + (user_stock_id ? '/' + user_stock_id : ''),
        data: {
          user: user.id,
          stock_id: stock_id,
          user_stock_id: user_stock_id,
          count: isNaN(count) ? 0 : count
        },
        method: user_stock_id ? 'PATCH' : 'POST',
        dataType: 'json',
        beforeSend: toggle_spinners($btn)
      })
        .done((data) => { $this.replaceWith(templates.stock(data.data)); })
        .fail((data) => { $this.replaceWith(templates.error({msg: 'Failed to add stock.'})); });
    })
    .on('click', 'button.remove-stock-from-portfolio, button.remove-stock-from-watchlist', function () {
      var $btn = $(this),
          $this = $btn.closest('[data-stock-id]'),
          user_stock_id = parseInt($this.attr('data-user-stocks-id')) || null,
          action = $this.closest('[data-rm-action]').attr('data-rm-action');

      $.ajax({
        url: '<%= user_stocks_path %>/' + user_stock_id,
        method: 'DELETE',
        dataType: 'json',
        beforeSend: toggle_spinners($btn)
      })
        .done((data) => {
          if (action == 'remove') {
            $this.parent().remove();
          } else {
            $this.replaceWith(templates.stock(data.data));
          }
        })
        .fail((data) => { $this.replaceWith(templates.error({msg: 'Failed to remove stock.'})); });
    })

    // manipulating friendships
    .on('click', 'button.view-friend', function () {
      window.location.href = '<%= friends_path %>/' + $(this).closest('[data-user-id]').attr('data-user-id');
    })
    .on('click', 'button.add-friendship', function () {
      window.location.href = '<%= friends_path %>/' + $(this).closest('[data-user-id]').attr('data-user-id');
    })
    .on('click', 'button.remove-friendship', function () {
      var $btn = $(this),
          user_id = $btn.closest('[data-user-id]').attr('data-user-id');

      $.ajax({
        url: '<%= friends_path %>/' + user_id,
        method: 'DELETE',
        dataType: 'json',
        beforeSend: toggle_spinners($btn)
      })
        .done((data) => { $this.closest('tr').remove(); })
        .fail((data) => { $this.replaceWith(templates.error({msg: 'Failed to remove friendship.'})); });
    });


  // Handle numeric inputs into the count input
  $(document).on('keyup keydown', 'input.stock-count-edit', function (ev) {
    if ((ev.keyCode < 48 || ev.keyCode > 57) && [8, 9, 13, 46].indexOf(ev.keyCode) == -1) {
      ev.preventDefault();
    }
  });

  <% end %>


  // Pre-load helpers
  Handlebars.registerHelper('math', function (lvalue, operator, rvalue, options) {
    lvalue = parseFloat(lvalue);
    rvalue = parseFloat(rvalue);

    var v = {
        '+': lvalue + rvalue,
        '-': lvalue - rvalue,
        '*': lvalue * rvalue,
        '/': lvalue / rvalue,
        '%': lvalue % rvalue
    }[operator].toFixed(options.hash.precision || -1);
    if (options.hash.thousands) {
      v = v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, options.hash.thousands);
    }
    if (options.hash.prefix) {
      v = options.hash.prefix + v;
    }
    if (options.hash.suffix) {
      v+= options.hash.suffix;
    }
    return v;
  });


  // Load all templates
  $('script[type|="text/x-handlebars"]').each((() => {
    var hclr = /^(text\/x\-)?handlebars\-/;

    return function () {
      var id = this.id.replace(hclr, ''),
          type = this.getAttribute('type').replace(hclr, '');

      if (type == 'partial') {
        partials[id] = Handlebars.registerPartial(id, this.innerHTML);
      }
      templates[id] = Handlebars.compile(this.innerHTML);
      console.log(templates.hasOwnProperty(id), id + ' ' + type + ' loaded.', this);
    };
  })());
  spinner = templates.spinner();


  // Immediate executions
  if (search_val != '') {
    nav_search.submit();
  }

  window.railsstockapp = {
    templates: templates
  };
});
</script>
